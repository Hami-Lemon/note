# 变换

## 	线性变换

### 缩放(scale)

![image-20210522165537529](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522165537529.png)
$$
\begin{bmatrix}  
 x'\\y'
\end{bmatrix} =
\begin{bmatrix} 
  s & 0\\0&s
\end{bmatrix}
\begin{bmatrix} 
  x\\y
\end{bmatrix}
$$


### 镜像(reflection)

y轴坐标不变，x轴坐标变为$-x$

![image-20210522165954189](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522165954189.png)
$$
\begin{bmatrix}
x'\\y'
\end{bmatrix}=
\begin{bmatrix}
-1 & 0 \\0 & 1
\end{bmatrix}
\begin{bmatrix}
x\\y
\end{bmatrix}
$$

### 切变（shear)

y轴坐标不变，x轴坐标变为$x+ay$

![image-20210522170243689](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522170243689.png)
$$
\begin{bmatrix}  
 x'\\y'
\end{bmatrix} =
\begin{bmatrix} 
  1 & a\\0&1
\end{bmatrix}
\begin{bmatrix} 
  x\\y
\end{bmatrix}
$$

### 旋转（rotate）

默认绕原点逆时针旋转

$R_{-\theta} = R_{\theta}^{T}$

![image-20210522170853094](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522170853094.png)
$$
\begin{bmatrix}  
 x'\\y'
\end{bmatrix} =
\begin{bmatrix} 
  \cos \theta & -\sin \theta\\
   \sin \theta& \cos \theta
\end{bmatrix}
\begin{bmatrix} 
  x\\y
\end{bmatrix}
$$

## 齐次坐标（Homogeneous Coordinates)

对平移操作时，不能用$x' = Mx$表示，所以引入齐次坐标$(x,y,w)$，使所有操作都一致且为线性运算

当$w\neq 0时，表示点（x/w,y/w,1)$
$$
2D\ Point: (x,\ y,\ 1)^{T}\\
2D\ Vector: (x,\ y,\ 0)^{T}\\
向量+向量=向量\\
点-点=向量\\
点+向量=点\\
点+点=两点的中点
$$

### 平移(translate)

![image-20210522171539251](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522171539251.png)
$$
\begin{bmatrix}  
 x'\\y'\\w'
\end{bmatrix} =
\begin{bmatrix} 
  1 & 0 & t_{x}\\
  0 & 1 & t_{y}\\
   0&0&1
\end{bmatrix}
\begin{bmatrix} 
  x\\y\\1
\end{bmatrix}
$$

### 复合变换

**需要注意顺序**

![image-20210522172806371](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522172806371.png)

![image-20210522172830442](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522172830442.png)

运算顺序，从右到左逐个应用

![image-20210522173404737](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522173404737.png)

例：先旋转后平移
$$
T_{(1.0)} \cdot R_{45} 
\begin{bmatrix}
x\\y\\1
\end{bmatrix}
$$

## 3D 变换

同2D变换，只是增加一个z轴
$$
3D\ point = (x,\ y,\ z,\ 1)^{T}\\
3D\ vector = (x,\ y,\ z,\ 0)^{T}
$$

### 3D 旋转

![image-20210522174636591](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522174636591.png)

罗德里格旋转公式(Rodrigues' Rotation Formula)：

绕旋转轴n(点$(n_{x},n_{y},n_{z})$和原点的连线)

`I`为单位矩阵

![image-20210522175539523](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522175539523.png)

## 观测变换（Viewing transformation)

### 视图/相机变换（View / Camera transformation)

#### 定义相机

- 相机的位置（position) $\vec{e}$
- 相机朝向(look-at / gaze direction)$\hat{g}$
- 向上方向(up direction)$\hat{t}$

约定：相机始终在原点，y轴为up direction,看向$-z$方向

![image-20210522181537524](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522181537524.png)

### 投影变换(Projection transformation)

将3D空间的物体在2D空间中呈现出来

![image-20210522211343224](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522211343224.png)

正交投影和透视投影的区别：透视投影存在**近大远小**，正交投影不存在

![image-20210522212013292](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522212013292.png)

#### 正交投影(Orthographic projection)

简单理解：将相机放在原点，看向-z方向，y轴为上方；扔掉z轴；将图形移动和缩放至$[-1, 1]^{2}$的矩形区域内，即为正交投影。

![image-20210522212651288](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522212651288.png)

通常操作：将一个立方体**[l,r] x [b, t] x [f, n]**，移动和缩放至$[-1,1]^{3}$的标准立方体

这里使用右手坐标系，所以$n>f$    ($near > far$)，离得越近，z轴的值越大

![image-20210522213416105](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522213416105.png)

![image-20210522213647031](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522213647031.png)

计算得：
$$
M_{ortho} = \begin{bmatrix}
\frac{2}{r-l} & 0 & 0 & -\frac{r+l}{r-l}\\
0 & \frac{2}{t-b} & 0 & -\frac{t+b}{t-b}\\
0 & 0 & \frac{2}{n-f} & -\frac{n+f}{n-f}\\
0 & 0 & 0 & 1
\end{bmatrix}
$$


#### 透视投影(Perspective projection)

理解：将一个立锥体“挤压”成一个立方体，然后对这个立方体做正交投影。

“挤压”的规定：近平面大小不变，近平面与远平面的距离不变，中心点的位置不变

![image-20210522215406468](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522215406468.png)

“挤压”过程：

![image-20210522215629365](images/%E4%B8%80%E5%8F%98%E6%8D%A2/image-20210522215629365.png)
$$
y' = \frac{n}{z} y\\
x' = \frac{n}{z} x
$$
推导出“挤压”矩阵([推导过程](https://zhuanlan.zhihu.com/p/122411512))：
$$
M_{p\rightarrow o} = \begin{bmatrix}
n & 0 & 0 & 0\\
0 & n & 0 & 0\\
0 & 0 & n+f & -nf\\
0 & 0 & 1 & 0
\end{bmatrix}
$$
最后得出透视投影矩阵为：
$$
\begin{equation}
M_{persp} = M_{ortho} * M_{p \rightarrow o}
\xlongequal{化简}
\begin{bmatrix}
\frac{2n}{r-l} & 0 & \frac{l+r}{l-r} & 0\\
0 & \frac{2n}{t-b} & \frac{b+t}{b-t} & 0\\
0 & 0 &\frac{f+n}{n-f} & \frac{2fn}{f-n}\\
0 & 0 & 1 & 0
\end{bmatrix}
\end{equation}
$$

### 另一种形式

 使用`fov(视场角)`、`aspect（宽高比）`、`far（远平面）`、`near（近平面）`作为参数

平头锥体右侧切面图（$\alpha$ 即为`fov`）：

![img](images/%E4%B8%80%E5%8F%98%E6%8D%A2/v2-811b29f45de8298bc691779a05244abe_720w.jpg)

由图可得：
$$
n = near\qquad f = far\\
t = near * \tan{(fov / 2)}\qquad b = -t\\
r = aspect * t\qquad l = -r
$$
得出矩阵为：
$$
正交投影矩阵：M_{ortho} = 
\begin{bmatrix}
\frac{\cot{(fov/2)}}{aspect * near} & 0 & 0 & 0\\
0 & \frac{\cot{(fov/2)}}{near} & 0 & 0\\
0 & 0 & \frac{2}{near - far} & -\frac{near+far}{near-far}\\
0 & 0 & 0 & 1
\end{bmatrix}\\
透视投影矩阵：M_{persp} = 
\begin{bmatrix}
\frac{\cot{(fov/2)}}{aspect} & 0 & 0 & 0\\
0 & \cot{(fov/2)} & 0 & 0\\
0 & 0 & \frac{near+far}{near-far} & -\frac{2*near*far}{near-far}\\
0 & 0 & 1 & 0
\end{bmatrix}
$$
